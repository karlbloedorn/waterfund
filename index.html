<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
	<meta name="viewport" content="initial-scale=1">
    <title id="title">Putting Suppliers On The Map</title>
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.12/semantic.min.css">  
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Encode+Sans" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css" />    
    <link rel="stylesheet" href="site.css" />
    <style>
   
    </style>
</head>
<body>
    <div id="detail_modal" class="ui longer modal">
        <h2 id="detail_modal_header" class="header">
        </h2>
        <div id="detail_modal_scrollarea" class="scrolling image content">
            <div id="detail_modal_profile_image_wrapper" class="ui large circular image">
                <img id="detail_modal_profile_image" class='img-circle selected'>
            </div>
            <div class="description">
                <p class=''><span id="detail_modal_story"></span></p>
                <div id="detail_modal_gallery" class="gallery">
                </div>  
            </div>
        </div>
        <div class="actions">
            <div class="ui primary approve button">
            Close
            <i class="right chevron icon"></i>
            </div>
        </div>
    </div>

     <section id="introSection" class="full-screen">
            
        <div id='video'>
            <div id="titlecontent">
                <span data-i18n="project_title"></span>
                <h3><span data-i18n="project_subtitle"></span></h3>
            </div>   
                      
            <div id="lang_buttons">
                <button id='lang_english' class="ui black button">
                        English
                </button>
                <button  id='lang_espanol' class="ui black button">
                        Espa√±ol
                </button>
            </div>
        </div>
    </section>
    <br>
    <div class="ui container" id="background" role="main">

        <div class="ui grid">
            <div class="ten wide computer only column">
                <h1 data-i18n="background_title" style="margin-top: 10px !important;"></h1> 

                <p class='background_text'><span data-i18n="[html]background_intro"></span>
                </p>
                <p class='background_text'><span data-i18n="[html]background_watersheds"></span>
                </p>
                <p class='background_text'><span data-i18n="[html]background_subwatersheds"></span>
                </p>
            </div>
            <div class="six wide computer only column">
                <div id="map" class='visible-md-block visible-lg-block'></div>
            </div>    
            
            <div class="sixteen wide mobile tablet only column">
                    <h1 data-i18n="background_title" style="margin-top: 10px !important;"></h1> 

                    <p class='background_text'><span data-i18n="[html]background_intro"></span>
                    </p>
                    <br>
                    <img class="ui centered medium image" src="img/testmap/1.png">
                
                    <p class='background_text'><span data-i18n="[html]background_watersheds"></span>
                    </p>
                    <br>
                    <img class="ui centered medium image" src="img/testmap/2.png">
                                        
                    <p class='background_text'><span data-i18n="[html]background_subwatersheds"></span>
                    </p>
                    <br>
                    <img class="ui centered medium image" src="img/testmap/4.png">                    
                    
            </div>
        </div>
    </div>

    <div id='sections'>

    </div>
    <br>
    <center>
        <div class="ui small images">
            <a href="https://www.naturalcapitalproject.org/" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="Natural Capital Project" src="img/logos/logo_natcap.png"/>
            </a>
            <a href="http://environment.umn.edu/" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="University of Minnesota, Institute on the Environment" src="img/logos/logo_ione.png"/>
            </a>
            <a href="http://www.asocana.org/modules/documentos/11981.aspx" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="Fondo Agua por la vida y la sostenibilidad" src="img/logos/logo_fondo_de_agua.png"/>
            </a>
            <a href="https://twitter.com/asobolo?lang=en" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="Asobolo" src="img/logos/logo_asobolo.png"/>
            </a>
            <a href="http://www.uhero.hawaii.edu/" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="University of Hawaii, Economic Research Organization" src="img/logos/logo_uhero.png"/>
            </a>
            <a href="http://www.wrrc.hawaii.edu" class="ui medium image">
                <img style="width:128px;height:128px;" class="ui medium image" alt="University of Hawaii at Manoa, Water Resources Research Center" src="img/logos/logo_wwrc.png"/>
            </a>
        </div>
    </center>
    <br>
    <div class="ui inverted vertical footer segment">
        <div class="ui container">
            <div class="ui stackable inverted divided equal height stackable grid">
                <div class="four wide column">
                    <h4 class="ui inverted header">About</h4>
                    <div class="ui inverted link list">
                    <a href="#" class="item">Contact Us</a>
                    <a href="#" class="item">Funding</a>
                    </div>
                </div>
                <div class="seven wide column">
                    
                    <h4 class="ui inverted header">Credits &amp; Acknowledgements</h4>
                    <p>
                        This project was made possible by the participants in Agua por la Vida who generously accepted to share their stories with us through this website. 
                        <br><br>
                        This project was led by Kelly Meza Prado in partnership with Asobolo, Agua por la Vida, and the Natural Capital project with the support of the University of Minnesota and the Belmont Forum through ClimateWise. 
                        <br><br>
                        We thank Kate Brauman, Leah Bremer, and Ryan Noe for the comments and support provided. 
                        <br><br>
                        Special thanks to Karl Bloedorn for donating his time to provide design, web development, and overall technical support. 
                    </p>
                </div>
                <div class="five wide column">
                    <h4 class="ui inverted header">Send us your comment</h4>
                    
                    <p class='hide' id="FORM_success">
                        <br>
                        Thank you for your comment. <br><br>
                        <a class='ui button' id="FORM_another"> Send Another</a>
                    </p>
                    <form class="ui form inverted" id="FORM_all">
                        <div class="field">
                            <label>Name</label>
                            <input type="text" id="FORM_name" name="name" placeholder="">
                        </div>
                        <div class="field">
                            <label>Email Address</label>
                            <input type="text" id="FORM_email" name="email" placeholder="user@domain.com">
                        </div>
                        <div class="field">
                            <label>Comment</label>
                            <textarea id='FORM_comment' rows="4"></textarea>
                        </div>
                        <img src="img/spinner.gif" class='hide' id="FORM_spinner">
                        <button class="ui button" id="FORM_submit">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.12/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js" crossorigin=""></script>
    <script src="lib/jquery.i18n.js"></script>
    <script src="lib/jquery.i18n.messagestore.js"></script>
    <script src="lib/jquery.i18n.fallbacks.js"></script>
    <script src="lib/jquery.i18n.parser.js"></script>
    <script src="lib/jquery.i18n.emitter.js"></script>
    <script src="lib/jquery.i18n.language.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>    
    <script>
        $(document).ready(function(){

            $("#FORM_submit").click(function(e){

                $("#FORM_spinner").removeClass('hide');
                $("#FORM_submit").addClass('hide');

                var body = {
                    "name" : $("#FORM_name").val(),
                    "email" : $("#FORM_email").val(),
                    "comment" : $("#FORM_comment").val()
                };                

                $.ajax({
                    url: "https://waterfundapi.azurewebsites.net/api/LeaveComment",
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify(body),
                    success: function(data){
                        $("#FORM_submit").removeClass('hide');
                        $("#FORM_spinner").addClass('hide');
                        $("#FORM_name").val("");
                        $("#FORM_email").val("");
                        $("#FORM_comment").val("");
                        $("#FORM_all").addClass('hide');
                        $("#FORM_success").removeClass('hide');
                    },
                    error: function(res){
                        $("#FORM_submit").removeClass('hide');
                        $("#FORM_spinner").addClass('hide');
                        alert(res.responseText);
                    },
                    type: 'POST',
                    processData: false,
                }); 
                e.preventDefault();             
            });
        
            $("#FORM_another").click(function(){
                $("#FORM_all").removeClass('hide');
                $("#FORM_success").addClass('hide');
            });
            
            var data=[
                {
                    items:[{key:"amalia",images:["DSC00041","DSC00492","101_1665","108_7672","DSC07261","DSC07278"]},
                    {key:"school",images:["DSC00157","DSC00134","DSC00136","DSC00143"]}
                    ]},
                {
                    items:[{key:"guido",images:["DSC00314","DSC00330","DSC00339","DSC05337","P1010071"]},
                        
                        {key:"manuel",images:["DSC02800","DSC02784","DSC02791","P1010911","P1010913"]},
                        {key:"community",images:["DSC00078","DSC00089","DSC00093","DSC00115","DSC00123"]}]},
                {
                    items:[{key:"diego",images:["DSC00428","DSC00446","P1030766","P1030882","P1050733"]},
                        {key:"humberto",images:["DSC00374","108_6873","108_7543","108_7546","P1100449","108_7536"]},
                        {key:"oscar",images:["DSC00500","DSC00507","DSC00509","DSC00531"]}]},
                {
                    items:[{key:"otoniel",images:["DSC00426","P1140705","P1140712","P1160183","P1160992"]},
                        {key:"ediberto",images:["DSC00021","DSC00032","P1080776","P1120067","108_7313"]},
                        {key:"trujillo",images:["P1090557","P1100233","P1100235","P1100374","P1100398"]}]},
                {
                    items :[
                        {key: "employee", images: ["DSC00546", "DSC00563", "DSC00560", "DSC00423", "DSC00385"]}
                    ]}];

            var mapTriggers=[
         /* {triggerElement:"#item_colombia",mapZoomLevel:4,minLatitude:-5,maxLatitude:15,minLongitude:-79.85,maxLongitude:-65.833,color:"#fec44f",leftLatitude:4.166858,leftLongitude:-77.525039,pane:"colombia"},*/
                {triggerElement:"#item_cauca_river",mapZoomLevel:6,minLatitude:.9,maxLatitude:5.30535,minLongitude:-78.213,maxLongitude:-75.48148,color:"#7fcdbb",pane:"departments"},
                {triggerElement:"#item_fifteen_watersheds",mapZoomLevel:8,minLatitude:2.649586,maxLatitude:5.25117,minLongitude:-76.869759,maxLongitude:-75.70077,color:"#31a354",pane:"fund"},
                {triggerElement:"#item_asobolo",mapZoomLevel:10,minLatitude:3.34986,maxLatitude:3.60117,minLongitude:-76.491,maxLongitude:-76.030077,color:"#c51b8a",pane:"fund"}];
            
            // Add all the sections
            var sections = $("#sections");
            _.each(data, function(section, sectionIndex){
                var section_container = $("<div>");
                var section_header_text = $("<h1 class='ui'>");
                $(section_header_text).attr('data-i18n', 'section_header_' + (sectionIndex+1));
                $(section_container).append(section_header_text);

                var section_grid = $("<div class='ui container'>");
                $(sections).append(section_grid);
                $(section_grid).append(section_container);
                var item_container = $("<div class='ui doubling stackable cards'>");
                if(section.items.length > 1){
                    $(item_container).addClass('three');
                } else {
                    $(item_container).addClass('three');
                }
                $(section_container).append(item_container);

                // Add each item in the section
                _.each(section.items, function(item, itemIndex){
                    var item_card = $("<div class='ui raised link card'>");
                    $(item_card).addClass('blue');
                    $(item_container).append(item_card);
                    var item_card_content = $("<div class='content'>");
                    $(item_card).append(item_card_content);
                    var item_header = $("<div class='header'></div>");
                    $(item_header).attr('data-i18n', 'person_name_' + item.key);
                    $(item_card_content).append(item_header); 
                    var item_description = $("<div class=''>");
                    $(item_description).attr('data-i18n', 'person_quote_' + item.key);
                    $(item_card_content).append(item_description);
                    var avatar_image = $("<img class='ui tiny circular image'>");
                    $(avatar_image).attr('src', 'people/' + item.key + ".png");
                    var gallery = $("<div class='summary_gallery gallery'>");
                    $(item_card_content).append(gallery);

                    _.each(item.images, function(image, imageIndex){
                        var img = $("<div class='gallery-picture'>");
                        $(img).css('background-image', "url('img/" +item.key + '/' + image + "_tn.JPG')");
                        $(gallery).append(img);
                    });

                    $(item_card).click(function(e){
                        $("#detail_modal_story").html( $.i18n( 'person_story_' + item.key, { 'interpolation': {'escapeValue': false} } ));
                        $("#detail_modal_header").html($.i18n('person_name_' + item.key));

                        if(item.key == 'employee'){
                            $("#detail_modal_profile_image_wrapper").css('display', 'none');
                        } else {
                            $("#detail_modal_profile_image_wrapper").css('display', 'block');
                        }
                        $("#detail_modal_profile_image").attr("src", 'people/' + item.key + ".png");
                        $("#detail_modal_gallery").html("");

                        _.each(item.images, function(image, imageIndex){
                            var image_link = $("<a>");
                            $(image_link).attr("data-fancybox", item.key);
                            $(image_link).attr("data-translate-caption", 'caption_' + item.key + '_' + (imageIndex +1));
                            $(image_link).attr("href", 'img/' +item.key + '/' + image + '.JPG');
                            $("#detail_modal_gallery").append(image_link);

                            var img = $("<img class='gallery-picture'>");
                            $(img).attr('src', 'img/' +item.key + '/' + image + '_tn.JPG');
                            $(image_link).append(img);
                            $(img).css('height', '80px' );
                        });

                        $(".gallery").children().each(function () {
                            var captionKey =  $(this).data("translate-caption");
                            if(captionKey != null){
                                $(this).data("caption",  $.i18n(captionKey));
                            } else {
                                console.log(captionKey);
                                $(this).data("caption",  'CAPTION NEEDED');
                            }
                        });
                        $('#detail_modal').i18n();
                        $('#detail_modal').modal({
                            onHide: function(){
                                $("#detail_modal_scrollarea").scrollTop(0);
                            }
                        }).modal('show');
                    });
                });
            });

            $.i18n.debug = false;

            var selectedLanguage = localStorage.getItem('language');
            if(selectedLanguage != null){
                $.i18n().locale = selectedLanguage;
                //$("#lang-select").val(selectedLanguage);
            } else {
                $.i18n().locale = 'en';
            }

            /*
            TODO slideshow
            var images=new Array('img/DSC00562_optimized.jpg','img/manuel/DSC02784.JPG',);
            var nextimage=0;
            doSlideshow();

            function doSlideshow(){
                if(nextimage>=images.length){
                    nextimage=0;
                }
                $('#video').css('background-image', "url('" + images[nextimage++]+ "')");
                //setTimeout(doSlideshow,2000);
            }*/

            function addGeoJsonToMap(map, filename, pane, styleFunc){
                $.getJSON(filename, function(json) {
                    var layer = L.geoJSON(json, {
                        style: styleFunc,
                        pane: pane
                    }).addTo(map);
                });
            }

            _.each(mapTriggers, function(mapTrigger, i){

                mapTrigger.polygon = L.polygon([
                    [mapTrigger.minLatitude , mapTrigger.minLongitude],
                    [mapTrigger.minLatitude ,  mapTrigger.maxLongitude],
                    [ mapTrigger.maxLatitude,  mapTrigger.maxLongitude],
                    [ mapTrigger.maxLatitude,  mapTrigger.minLongitude],
                ], {
                    color: "#FFF",
                    fillColor: "#000000",
                    fillOpacity: 0.0,
                    weight: 3,
                    pane: 'test'
                });
            });

            $.i18n().load( {
                en: 'i18n/en.txt',
                es: 'i18n/es.txt'
             }).done( function() {

                function renderLanguage(){
                    $('body').i18n();

                    //project_title

                    $(".mobile").find(".highlighted_word").removeClass("highlighted_word");
                    $(".highlighted_word").append(" <i class='location arrow blue icon'></i>");

                    _.each(mapTriggers, function(mapTrigger, i){

                    $(mapTrigger.triggerElement).hover(
                        function() {
                            map.stop()	
                            map.setView([3.41, -76.24], mapTrigger.mapZoomLevel); 
                            mapTrigger.polygon.addTo(map);
                        }, function() {
                            mapTrigger.polygon.removeFrom(map);
                        });
                    });

                }
                renderLanguage();

                function scrollDown(){
                    $('html, body').animate({scrollTop:$('#background').position().top}, 'slow');
                    $('#background').focus();
                }
                
                // set up the language selector
                $("#lang_english").click(function() {
                    localStorage.setItem('language', 'en');
                    $.i18n().locale = 'en';
                    renderLanguage();
                    scrollDown();
                });

                 $("#lang_espanol").click(function() {
                    localStorage.setItem('language', 'es');
                    $.i18n().locale = 'es';
                    renderLanguage();
                    scrollDown();
                });

                var map = L.map('map').setView([3.41, -76.24], 3);
                L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }).addTo(map);
                map.scrollWheelZoom.disable();
                
                var pane_colombia = map.createPane('colombia');
                var pane_departments = map.createPane('departments');
                var pane_fund = map.createPane('fund');
                var pane_polygons = map.createPane('test');

                addGeoJsonToMap(map, "data/Col_limits.txt", 'colombia', function(){
                    return {  
                        weight: 4,
                        opacity: 1,
                        color: '#fec44f', 
                        fillOpacity: 0.0,
                    };
                });

                addGeoJsonToMap(map, "data/Dep_fondo.txt", 'departments', function(){
                    return {  
                        weight: 3,
                        opacity: 1,
                        color: '#7fcdbb', 
                        fillOpacity: 0.0 
                    };
                });

                addGeoJsonToMap(map, "data/Fondo_work_areas.txt", 'fund', function(feature, i){
                    if(feature.properties.NOM_CUENCA === 'Bolo'){
                        return  {  
                            weight: 1, 
                            opacity: 1,  
                            color: 'white', 
                            fillOpacity: 0.7,
                            fillColor: "#c51b8a",
                        };
                    } else {
                        return  {  
                            weight: 1, 
                            opacity: 1,  
                            color: 'white', 
                            fillOpacity: 0.7,
                            fillColor: "#31a354",
                        };  
                    }
                });
            });        
        });
    </script>
</body>
</html>

